name: Despliegue de Portafolio Next.js

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
      # 1. Descarga el código
      - name: Checkout del código
        uses: actions/checkout@v4

      # 2. Construir la imagen de Docker
      # Aquí es donde ocurre el 'npm run build' dentro del contenedor
      - name: Construir imagen Docker
        run: |
          docker build -t portafolio-nextjs:latest .

      # 3. Detener y eliminar el contenedor anterior (si existe)
      # El '|| true' evita que el workflow falle si es la primera vez que se corre
      - name: Limpiar contenedor anterior
        run: |
          docker stop portafolio-app || true
          docker rm portafolio-app || true

      # 4. Ejecutar el nuevo contenedor
      # Pasamos los secretos como variables de entorno directamente al contenedor
      - name: Iniciar contenedor Docker
        run: |
          docker run -d \
            --name portafolio-app \
            -p 3000:3000 \
            --restart always \
            -e NODE_ENV=production \
            -e SMTP_HOST="${{ secrets.SMTP_HOST }}" \
            -e SMTP_PORT="${{ secrets.SMTP_PORT }}" \
            -e SMTP_SECURE="${{ secrets.SMTP_SECURE }}" \
            -e SMTP_USER="${{ secrets.SMTP_USER }}" \
            -e SMTP_PASS="${{ secrets.SMTP_PASS }}" \
            -e SMTP_FROM="${{ secrets.SMTP_FROM }}" \
            -e SMTP_TO="${{ secrets.SMTP_TO }}" \
            -e MY_GITHUB_TOKEN="${{ secrets.MY_GITHUB_TOKEN }}" \
            portafolio-nextjs:latest

      # 5. Limpieza de imágenes huérfanas (opcional pero recomendado)
      - name: Eliminar imágenes antiguas
        run: docker image prune -f